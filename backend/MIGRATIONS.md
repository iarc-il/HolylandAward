# Database Migrations Setup

## âœ… Migration Architecture Added!

You now have a proper migration system using **Alembic** for your PostgreSQL database.

## What Changed

### 1. **Before (Manual Table Creation)**
```python
# In main.py - BAD for production
Base.metadata.create_all(bind=engine)
```

### 2. **After (Proper Migrations)**
```bash
# Version-controlled, rollback-safe migrations
uv run alembic upgrade head
```

## **CRITICAL: Fresh Deployment Fix**

### **Problem Solved** âœ…
The initial migration is now **PROPER** and creates tables from scratch:

```python
# In alembic/versions/9b241c567b38_create_qso_logs_table.py
def upgrade() -> None:
    op.create_table('qso_logs',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('date', sa.String(), nullable=True),
        # ... all columns and constraints ...
    )
```

### **Fresh Deployment Now Works** ðŸŽ‰
```bash
# On brand new production server
createdb holyland_award
uv run alembic upgrade head  # âœ… Creates all tables!
```

## Migration Commands

### **Daily Development**
```bash
# Generate migration after model changes
uv run alembic revision --autogenerate -m "Add new column"

# Apply migrations
uv run alembic upgrade head

# Check current migration status
uv run alembic current

# See migration history
uv run alembic history
```

### **Production Deployment**
```bash
# Apply all pending migrations
uv run alembic upgrade head

# Rollback one migration
uv run alembic downgrade -1

# Rollback to specific version
uv run alembic downgrade <revision_id>
```

## Example Workflow

### **Adding a New Column**
1. **Modify your model:**
```python
# In qsos/models.py
class QSOLogs(Base):
    __tablename__ = "qso_logs"
    
    id = Column(Integer, primary_key=True)
    # ... existing columns ...
    notes = Column(String, nullable=True)  # NEW COLUMN
```

2. **Generate migration:**
```bash
uv run alembic revision --autogenerate -m "Add notes column to QSOLogs"
```

3. **Review the generated migration:**
```python
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('qso_logs', sa.Column('notes', sa.String(), nullable=True))
    # ### end Alembic commands ###
```

4. **Apply migration:**
```bash
uv run alembic upgrade head
```

## Benefits You Now Have

### âœ… **Version Control**
- All schema changes tracked in git
- Team collaboration on database changes
- Rollback capabilities

### âœ… **Production Safety**
- No data loss during schema changes
- Incremental, tested updates
- Rollback if issues occur

### âœ… **Environment Consistency**
- Same schema across dev/staging/prod
- Reproducible deployments
- Automatic constraint handling

### âœ… **Team Collaboration**
- Merge conflicts in schema visible
- Shared migration history
- Documentation of schema evolution

## Current Status

- **Database**: PostgreSQL on port 5433 âœ…
- **Migration Tool**: Alembic configured âœ…
- **Initial Migration**: Generated (empty, table exists) âœ…
- **Application**: No longer uses Base.metadata.create_all() âœ…

## Next Steps

1. **For new model changes**: Use `alembic revision --autogenerate`
2. **For production**: Use `alembic upgrade head` in deployment scripts
3. **For team**: Commit migration files to git

You're now following **production-grade database practices**! ðŸŽ‰
